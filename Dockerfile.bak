FROM ghcr.io/btbn/ffmpeg-builds/base-win64:latest AS base
ENV TARGET=win64 VARIANT=gpl REPO=btbn/ffmpeg-builds ADDINS_STR=
FROM base AS layer-10-mingw
RUN --mount=src=scripts.d/10-mingw.sh,dst=/stage.sh run_stage /stage.sh
FROM base AS layer-10
COPY --from=layer-10-mingw /opt/mingw/. /
COPY --from=layer-10-mingw /opt/mingw/. /opt/mingw
FROM layer-10 AS layer-20-libiconv
RUN --mount=src=scripts.d/20-libiconv.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-10 AS layer-20-libxml2
RUN --mount=src=scripts.d/20-libxml2.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-10 AS layer-20-zlib
RUN --mount=src=scripts.d/20-zlib.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-10 AS layer-20
COPY --from=layer-20-libiconv $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-20-libxml2 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-20-zlib $FFBUILD_PREFIX/. $FFBUILD_PREFIX
FROM layer-20 AS layer-25-fftw3
RUN --mount=src=scripts.d/25-fftw3.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-freetype
RUN --mount=src=scripts.d/25-freetype.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-fribidi
RUN --mount=src=scripts.d/25-fribidi.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-gmp
RUN --mount=src=scripts.d/25-gmp.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-libogg
RUN --mount=src=scripts.d/25-libogg.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-openssl
RUN --mount=src=scripts.d/25-openssl.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25-xz
RUN --mount=src=scripts.d/25-xz.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-20 AS layer-25
COPY --from=layer-25-fftw3 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-freetype $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-fribidi $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-gmp $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-libogg $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-openssl $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-25-xz $FFBUILD_PREFIX/. $FFBUILD_PREFIX
FROM layer-25 AS layer-35-fontconfig
RUN --mount=src=scripts.d/35-fontconfig.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-25 AS layer-35
COPY --from=layer-35-fontconfig $FFBUILD_PREFIX/. $FFBUILD_PREFIX
FROM layer-35 AS layer-45-harfbuzz
RUN --mount=src=scripts.d/45-harfbuzz.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-libsamplerate
RUN --mount=src=scripts.d/45-libsamplerate.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-libudfread
RUN --mount=src=scripts.d/45-libudfread.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-libvorbis
RUN --mount=src=scripts.d/45-libvorbis.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-opencl
RUN --mount=src=scripts.d/45-opencl.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-vmaf
RUN --mount=src=scripts.d/45-vmaf.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-35 AS layer-45-vulkan
RUN --mount=src=scripts.d/45-vulkan.sh,dst=/stage.sh --mount=src=patches/vulkan,dst=/patches run_stage /stage.sh
FROM layer-35 AS layer-45
COPY --from=layer-45-harfbuzz $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-libsamplerate $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-libudfread $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-libvorbis $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-opencl $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-vmaf $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-45-vulkan $FFBUILD_PREFIX/. $FFBUILD_PREFIX
FROM layer-45 AS layer-50-amf
RUN --mount=src=scripts.d/50-amf.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-aom
RUN --mount=src=scripts.d/50-aom.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-avisynth
RUN --mount=src=scripts.d/50-avisynth.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-dav1d
RUN --mount=src=scripts.d/50-dav1d.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-davs2
RUN --mount=src=scripts.d/50-davs2.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-ffnvcodec
RUN --mount=src=scripts.d/50-ffnvcodec.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-glslang
RUN --mount=src=scripts.d/50-glslang.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-gme
RUN --mount=src=scripts.d/50-gme.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libass
RUN --mount=src=scripts.d/50-libass.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libbluray
RUN --mount=src=scripts.d/50-libbluray.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libmp3lame
RUN --mount=src=scripts.d/50-libmp3lame.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libopus
RUN --mount=src=scripts.d/50-libopus.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libtheora
RUN --mount=src=scripts.d/50-libtheora.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libvpx
RUN --mount=src=scripts.d/50-libvpx.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-libwebp
RUN --mount=src=scripts.d/50-libwebp.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-lilv
RUN --mount=src=scripts.d/50-lilv/96-lv2.sh,dst=/stage.sh run_stage /stage.sh
RUN --mount=src=scripts.d/50-lilv/96-serd.sh,dst=/stage.sh run_stage /stage.sh
RUN --mount=src=scripts.d/50-lilv/97-sord.sh,dst=/stage.sh run_stage /stage.sh
RUN --mount=src=scripts.d/50-lilv/98-sratom.sh,dst=/stage.sh run_stage /stage.sh
RUN --mount=src=scripts.d/50-lilv/99-lilv.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-mfx
RUN --mount=src=scripts.d/50-mfx.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-opencore-amr
RUN --mount=src=scripts.d/50-opencore-amr.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-openjpeg
RUN --mount=src=scripts.d/50-openjpeg.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-rav1e
RUN --mount=src=scripts.d/50-rav1e.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-rubberband
RUN --mount=src=scripts.d/50-rubberband.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-schannel
FROM layer-45 AS layer-50-sdl
RUN --mount=src=scripts.d/50-sdl.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-soxr
RUN --mount=src=scripts.d/50-soxr.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-srt
RUN --mount=src=scripts.d/50-srt.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-svtav1
RUN --mount=src=scripts.d/50-svtav1.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-twolame
RUN --mount=src=scripts.d/50-twolame.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-uavs3d
RUN --mount=src=scripts.d/50-uavs3d.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-vidstab
RUN --mount=src=scripts.d/50-vidstab.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-x264
RUN --mount=src=scripts.d/50-x264.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-x265
RUN --mount=src=scripts.d/50-x265.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-xavs2
RUN --mount=src=scripts.d/50-xavs2.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-xvid
RUN --mount=src=scripts.d/50-xvid.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50-zimg
RUN --mount=src=scripts.d/50-zimg.sh,dst=/stage.sh run_stage /stage.sh
FROM layer-45 AS layer-50
COPY --from=layer-50-amf $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-aom $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-avisynth $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-dav1d $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-davs2 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-ffnvcodec $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-glslang $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-gme $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libass $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libbluray $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libmp3lame $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libopus $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libtheora $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libvpx $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-libwebp $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-lilv $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-mfx $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-opencore-amr $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-openjpeg $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-rav1e $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-rubberband $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-schannel $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-sdl $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-soxr $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-srt $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-svtav1 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-twolame $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-uavs3d $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-vidstab $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-x264 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-x265 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-xavs2 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-xvid $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50-zimg $FFBUILD_PREFIX/. $FFBUILD_PREFIX
FROM base
COPY --from=layer-50 $FFBUILD_PREFIX/. $FFBUILD_PREFIX
COPY --from=layer-50 /opt/mingw/. /
